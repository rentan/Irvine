//Dorothy2
//caption=Utf8
//version=20140811.0
//hint=new Utf8 (str)
//match=
//author=rentan
//path=common
//end

/*
Copyright (C) 2012,2013,2014 rentan at rentan.org

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

(function () {


// ƒRƒ“ƒXƒgƒ‰ƒNƒ^
void function Utf8 (s) {
  if (nameOf (this) != 'Utf8') {
    alert ('new ‚È‚µ‚Å Utf8() ‚ªŒÄ‚Î‚ê‚Ü‚µ‚½B');
    exit ();
  }

  this.text = (isUndefined (s) || isNull (s)) ? '' : s.toString ();
};


// “à•”‚Åg—p: •¶šÀ‘ÌQÆ‚Ì•ÏŠ·ƒe[ƒuƒ‹
Utf8.prototype._charRefTable = null;

// “à•”‚Åg—p: •¶šÀ‘ÌQÆ‚Ì•ÏŠ·ƒe[ƒuƒ‹‚ğ“Ç‚İ‚Ş
Utf8.prototype._loadCharRefTable = function () {
  common_load ('utf8_charref');
};


// “à•”‚Åg—p: DLL ŒÄ‚Ño‚µ—p
Utf8.prototype._dll = (function () {
  var dll = new DynaCall ();
  dll.register ('kernel32', 'MultiByteToWideChar', 'f=s', 'i=ulslsl', 'r=l');
  dll.register ('kernel32', 'WideCharToMultiByte', 'f=s', 'i=ulslslss', 'r=l');
  return dll;
}) ();


// “à•”‚Åg—p: MultiByteToWideChar + WideCharToMultiByte ‚É‚æ‚é•ÏŠ·
//  http://msdn.microsoft.com/ja-jp/library/cc448053.aspx
//  http://msdn.microsoft.com/ja-jp/library/cc448089.aspx
Utf8.prototype._toSJIS = function (sb) {
  var wc_len, sj_len;

  var CP_UTF8 = 65001;
  var CP_ACP = 0;

  // UTF-8 ‚©‚ç ƒƒCƒh•¶š—ñ‚É•ÏŠ·
  wc_len = this._dll.MultiByteToWideChar (CP_UTF8, 0, sb, sb.length, null, 0);
  var wc = new StringBuffer (wc_len * 2);
  wc_len = this._dll.MultiByteToWideChar (CP_UTF8, 0, sb, sb.length, wc, wc_len);

  // ƒƒCƒh•¶š—ñ‚©‚ç Shift_JIS ‚É•ÏŠ·
  var wc_flags = 0x200;  // WC_COMPOSITECHECK

  sj_len = this._dll.WideCharToMultiByte (CP_ACP, wc_flags, wc, wc_len, null, 0, null, null);
  var sj = new StringBuffer (sj_len);
  sj_len = this._dll.WideCharToMultiByte (CP_ACP, wc_flags, wc, wc_len, sj, sj_len, null, null);

  return sj.toString ();
};


// “à•”‚Åg—p: WideCharToMultiByte ‚Åˆ—‚Å‚«‚È‚¢•¶š‚Ì•ÏŠ·ƒe[ƒuƒ‹
//  Unicode ƒR[ƒhƒ|ƒCƒ“ƒg: 'Shift_JIS•¶š—ñ',
Utf8.prototype._u2sTable = {
0x5C: '_',
0x85: 'c',
0x86: 'õ',
0x87: 'ö',
0x88: '^',
0x89: 'ñ',
0xA0: ' ',
0xA6: 'úU',
0xA9: '(C)',
0xAE: '(R)',
0xBC: '1/4',
0xBD: '1/2',
0xBE: '3/4',
0x2002: ' ',
0x2003: '@',
0x2009: ' ',
0x200B: '',
0x200C: '',
0x200D: '',
0x2013: '-',
0x2014: '|',
0x2016: 'a',
0x2027: 'E',
0x2035: 'M',
0x2044: '/',
0x2122: 'TM',
0x2153: '1/3',
0x2154: '2/3',
0x2155: '1/5',
0x2156: '2/5',
0x2157: '3/5',
0x2158: '4/5',
0x2159: '1/6',
0x215A: '5/6',
0x215B: '1/8',
0x215C: '3/8',
0x215D: '5/8',
0x215E: '7/8',
0x215F: '1/',
0x2206: 'ƒ¢',
0x220F: 'ƒ®',
0x2212: '-',
0x2215: '/',
0x2217: '*',
0x2223: '|',
0x223C: '`',
0x2245: 'ß',
0x2264: '…',
0x2265: '†',
0x22C5: 'E',
0x3016: 'y',
0x3017: 'z',
0x301C: '`',
0x3094: '‚¤J',
0x3095: 'ƒ•',
0x3096: 'ƒ–',
0x3099: 'J',
0x309A: 'K',

// Œ‹‡•¶š‚Å‚È‚¢‘÷“_A”¼‘÷“_‚ğŒ‹‡‚³‚¹‚È‚¢
0x309B: 'J',
0x309C: 'K',

0x30A0: '=',
0x30F7: 'ƒJ',
0x30F8: 'ƒJ',
0x30F9: 'ƒ‘J',
0x30FA: 'ƒ’J',
0xFE50: ',',
0xFE51: '¤',
0xFE52: '.',
0xFE54: ';',
0xFE55: ':',
0xFE56: '?',
0xFE57: '!',
0xFE58: '-',
0xFE59: '(',
0xFE5A: ')',
0xFE5B: '{',
0xFE5C: '}',
0xFE5D: '[',
0xFE5E: ']',
0xFE5F: '#',
0xFE60: '&',
0xFE61: '*',
0xFE62: '+',
0xFE63: '-',
0xFE64: '<',
0xFE65: '>',
0xFE66: '=',
0xFE68: '_',
0xFE69: '$',
0xFE6A: '%',
0xFE6B: '@',
0xFEFF: '',

// from KCTRANS Big5/GB2312
19987:'ê',19994:'‹Æ',19995:'‘p',19996:'“Œ',19997:'ãN',20004:'—¼',20005:'Œµ',20007:'‘r',20016:'–L',20020:'—Õ',20026:'ˆ×',20029:'—í',20030:'¨',20039:'‘ï',20040:'›õ',20041:'‹`',20044:'‰G',20048:'Šy',20052:'‹ª',20064:'K',20065:'‹½',20070:'‘',20073:'–¥',20080:'”ƒ',20111:'åk',20122:'ˆŸ',20135:'Y',20137:'á[',20146:'e',20149:'åö',20159:'‰­',20165:'–™',20177:'›Å',20179:'‘q',20202:'‹V',20204:'˜ì',20221:'•ª',20223:'é—',20247:'O',20248:'—D',20249:'‰Î',20251:'˜û',20254:'ã„',20255:'ˆÌ',20256:'“`',20260:'',20262:'—Ï',20266:'‹U',20267:'âŒ',20296:'•z',20308:'è',20323:'—b',20325:'™@',20356:'–Ã',20387:'—µ',20389:'™F',20390:'ç¤',20391:'‘¤',20392:'‹¡',20394:'™P',20396:'™N',20407:'‹Ç',20446:'™`',20448:'‹ ',20454:'™Q',20456:'™V',20457:'˜í',20458:'™U',20461:'™L',20465:'‹ä',20502:'K',20526:'—‡',20538:'Â',20540:'’l',20542:'ŒX',20599:'˜÷',20603:'™C',20607:'',20642:'‰Æ',20645:'™W',20648:'–×',20649:'™T',20721:'ŒÙ',20741:'“–',20817:'™[',20839:'“à',20848:'—–',20851:'ŠÖ',20852:'‹»',20857:'ä¢',20859:'—{',20861:'b',20872:'‰ª',20891:'ŒR',20892:'”_',20911:'ég',20923:'“€',20928:'ò',20943:'Œ¸',20945:'–©',20964:'–P',20971:'éé',20975:'ŠM',20987:'Œ‚',20991:'èw',21005:'äØ',21010:'Šc',21016:'—«',21017:'‘¥',21018:'„',21019:'™Œ',21024:'™ˆ',21035:'•Ê',21037:'™',21041:'™Œ',21056:'™“',21058:'Ü',21070:'™‹',21073:'™›',21085:'”',21095:'Œ€',21124:'â²',21149:'Š©',21150:'™Ÿ',21153:'–±',21160:'“­',21170:'™¤',21171:'˜J',21183:'¨',21195:'™¬',21206:'™¦',21211:'™¬',21294:'™º',21326:'‰Ø',21327:'‹¦',21333:'åú',21334:'”„',21346:'á¸',21348:'àB',21351:'‰ç',21355:'‰q',21381:'œL',21382:'—ï',21387:'ˆ³',21388:'‰}',21397:'™Ì',21410:'›ù',21439:'Œ§',21441:'Q',21457:'”®',21464:'•Ï',21472:'ái',21497:'’V',21523:'Šd',21525:'˜C',21534:'“Û',21544:'“Ó',21551:'Œ[',21555:'Œà',21556:'Œà',21584:'™ã',21586:'š~',21587:'š”',21589:'šq',21591:'‰S',21592:'ˆõ',21593:'šD',21596:'šj',21652:'š\',21658:'êŠ',21659:'š†',21709:'‹¿',21713:'ˆ ',21719:'æ–',21796:'Š«',21799:'šc',21854:'ˆ ',21855:'Œ[',21863:'šs',21868:'š¥',21869:'š“',21870:'ê–',21880:'š‚',21943:'•¬',21947:'šg',21995:'š‘',22052:'š',22099:'‰R',22137:'“–',22158:'†',22160:'¦',22179:'š',22218:'”X',22242:'’c',22253:'‰€',22260:'ˆÍ',22270:'}',22278:'‰~',22307:'¹',22329:'šÛ',22330:'ê',22359:'‰ò',22362:'Œ˜',22363:'ã¢',22366:'šÇ',22367:'•­',22368:'’Ä',22383:'š­',22404:'šà',22405:'šà',22418:'—Û',22438:'¤',22441:'š¿',22488:'šË',22490:'šÄ',22535:'ä¿',22545:'šÍ',22681:'à­',22686:'‘',22771:'Šk',22774:'šå',22783:'šÑ',22788:'ˆ',22791:'”õ',22797:'•¡',22836:'“ª',22841:'‹²',22842:'’D',22849:'™»',22850:'šô',22859:'•±',22870:'àĞ',22918:'Ï',22919:'•w',22920:'›_',22930:'“i',22954:'›a',22986:'o',23020:'•P',23044:'˜K',23047:'›g',23067:'Œâ',23089:'Œâ',23092:'›e',23156:'‰d',23157:'›h',23210:'›[',23250:'ˆ¤',23252:'›l',23385:'‘·',23425:'”J',23454:'›†',23456:'’',23457:'R',23466:'Œ›',23467:'‹{',23485:'Š°',23486:'•o',23532:'Š°',23545:'‘Î',23547:'q',23548:'“±',23572:'›•',23576:'o',23581:'áR',23591:'‹Ä',23618:'‘w',23650:'Æ',23679:'›×',23681:'Î',23682:'æ¯',23702:'›Í',23703:'›¼',23706:'—’',23707:'›¸',23725:'—ä',23781:'›Â',23782:'›Û',23810:'™§',23853:'›Î',23854:'›¾',24005:'›Ú',24020:'›Ú',24034:'‘ƒ',24041:'èİ',24065:'•¼',24069:'ƒ',24072:'t',24079:'›é',24080:'’ ',24088:'—ú',24092:'›î',24102:'‘Ñ',24103:'›ê',24110:'›ñ',24124:'›ì',24130:'™p',24138:'›ë',24171:'›ñ',24198:'Œc',24208:'œI',24209:'œF',24211:'ŒÉ',24212:'‰',24217:'•_',24223:'á“',24260:'‰X',24298:'œH',24320:'ŠJ',24322:'ˆÙ',24338:'œU',24352:'’£',24377:'’e',24378:'‹®',24402:'‹A',24405:'˜^',24421:'•F',24443:'“O',24469:'œq',24492:'œf',24501:'’¥',24503:'œ{',24518:'‰¯',24527:'œñ',24551:'—J',24574:'œ¿',24576:'‰ù',24577:'‘Ô',24578:'œÏ',24579:'œá',24581:'œ®',24582:'œÆ',24635:'‘y',24639:'œâ',24691:'§',24694:'ˆ«',24696:'œÔ',24699:'œº',24700:'”Y',24703:'œÈ',24709:'‰x',24747:'œÀ',24748:'Œœ',24749:'œÊ',24751:'œà',24778:'‹Á',24809:'’¦',24811:'œŞ',24813:'œÍ',24814:'œİ',24815:'Šµ',24864:'œ°',24868:'•®',24913:'œĞ',25041:'œî',25042:'›n',25044:'œì',25099:'œû',25103:'‹Y',25112:'í',25125:'“™',25142:'ŒË',25143:'ŒË',25150:'–ß',25169:'–o',25191:'·',25193:'Šg',25194:'~',25195:'‘|',25196:'—g',25200:'ï',25242:'•',25247:'–',25250:'',25252:'Œì',25253:'•ñ',25291:'e',25311:'‹[',25315:'ƒ',25317:'—i',25320:'›',25321:'‘ğ',25370:'•',25371:'¹',25374:'£',25375:'p',25376:'š',25380:'©',25381:'Šö',25414:'«',25438:'',25439:'‘¹',25442:'Š·',25443:'¬',25527:'±',25581:'Œf',25593:'”w',25597:'®',25601:'¦',25605:'Šh',25620:'‘~',25668:'Û',25670:'²',25671:'—h',25672:'­',25674:'¸',25681:'’Í',25730:'œ',25792:'I',25802:'Œ‚',25874:'·',25890:'·',25932:'“G',25947:'Ÿa',25995:'Ö',26025:'a',26102:'',26103:'E',26137:'“Ü',26174:'Œ°',26195:'‹Å',26196:'@',26197:'ò',26198:'ô',26202:'”Ó',26242:'b',26279:'B',26280:'ø',26310:'—ï',26348:'N',26415:'Q',26421:'S',26432:'E',26434:'èµ',26435:'Œ ',26472:'—k',26497:'‹É',26500:'Œ',26526:'à',26531:'¥',26533:'ŸM',26538:'‘™',26539:'•–',26541:'†',26578:'µ',26588:'ŸC',26592:'ŸE',26597:'¸',26618:'i',26624:'‰',26629:'ò',26631:'•W',26632:'V',26633:'‹ù',26634:'×',26635:'“',26636:'”¥',26638:'ŸK',26639:'—“',26641:'÷',26679:'—l',26686:'ŸR',26700:'‘ì',26720:'“',26721:'ô',26724:'Æ',26725:'‹´',26726:'Š’',26816:'ŒŸ',26818:'ŸQ',26865:'—Å',26912:'ß',26925:'‘È',27012:'ŸS',27014:'¾',27016:'ŸL',27017:'ŸO',27046:'Š²',27048:'ï',27092:'İ',27099:'ŸB',27103:'ŸF',27126:'š',27153:'—À',27183:'ä€',27185:'÷',27243:'‰¡',27257:'ä„',27260:'ŸH',27284:'ƒ',27311:'äi',27379:'×',27384:'ŸO',27426:'é‰',27428:'Ÿb',27493:'•à',27495:'Šò',27506:'Î',27511:'—ğ',27516:'Ÿs',27521:'Ÿf',27527:'Ÿn',27538:'Ÿm',27546:'Ÿp',27553:'Ÿq',27585:'à›',27586:'çw',27596:'Ÿx',27599:'–ˆ',27605:'•L',27607:'”ù',27609:'Ë',27617:'Ÿ',27719:'œb',27721:'Š¿',27725:'—b',27737:'‰˜',27745:'‰˜',27748:'“’',27769:'Ÿ¦',27785:'’¾',27807:'a',27813:'àl',27814:'ŸË',27815:'Ÿé',27818:'Ÿô',27870:'à^',27895:'‘ê',27896:'àm',27899:'Šƒ',27900:'”¬',27901:'‘ò',27905:'Œ‰',27964:'ŒE',27971:'Ÿ³',27974:'Ÿ÷',27975:'àC',27978:'‘÷',27979:'‘ª',27982:'Ï',27983:'àg',27985:'ŸÓ',27986:'Ÿõ',27987:'”Z',27988:'àH',28034:'“h',28041:'Â',28063:'—ø',28065:'‰Q',28067:'ŸĞ',28068:'Ÿü',28070:'',28071:'ŠÀ',28072:'Ÿû',28073:'àG',28122:'Ÿ£',28173:'’Ğ',28174:'“À',28176:'‘Q',28180:'‹™',28182:'àc',28183:'Ÿø',28212:'Š‰',28291:'’×',28293:'àd',28297:'Ÿò',28331:'‰·',28348:'¼',28378:'Ÿö',28385:'–',28388:'àh',28389:'—”',28392:'à_',28393:'“å',28453:'ŒE',28487:'àn',28491:'àq',28497:'”¬',28572:'àp',28625:'£',28626:'•m',28678:'“À',28712:'£',28781:'–Å',28789:'—ì',28790:'â}',28798:'Ğ',28799:'W',28800:'àŒ',28822:'à—',28860:'˜B',28861:'à•',28865:'à¡',28866:'à£',28891:'C',28902:'”Ï',28903:'Ä',28908:'à',28909:'”M',28949:'à…',28976:'‰‹',29002:'õ',29124:'‰‹',29233:'ˆ¤',29239:'–ê',29261:'à¯',29301:'Œ¡',29306:'à¸',29322:'à·',29376:'ó',29384:'”‚',29406:'àÖ',29422:'‚',29423:'àÔ',29425:'–',29454:'—Â',29484:'å–',29549:'àÚ',29574:'ä¢',29595:'àó',29615:'ŠÂ',29616:'Œ»',29626:'£',29648:'àé',29649:'àú',29682:'àë',29712:'àò',29756:'àù',29815:'ˆ¤',29838:'àü',29862:'ˆ¤',29935:'áM',29986:'Y',29999:'”J',30005:'“d',30021:'’¨',30103:'—Ã',30111:'áŠ',30112:'á–',30113:'á‡',30124:'áœ',30126:'áŒ',30127:'á†',30132:'á}',30152:'á',30153:'áz',30166:'ˆ ',30184:'á”',30187:'á’',30201:'áƒ',30232:'á‘',30246:'‘‰',30302:'áš',30307:'á',30309:'Ç',30315:'áŸ',30338:'á£',30353:'á«',30385:'á°',30386:'á¯',30415:'áµ',30416:'‰–',30417:'ŠÄ',30424:'”Õ',30526:'O',30543:'¢',30545:'áÙ',30610:'áÔ',30633:'áß',30699:'‹¸',30710:'ˆé',30718:'âH',30719:'{',30721:'áù',30742:'áN',30746:'Œ¥',30782:'âI',30784:'‘b',30805:'×',30807:'âB',30830:'Šm',30839:'Œ²',30875:'â@',30897:'Œ²',30967:'—Ó',31087:'’õ',31096:'‰Ğ',31153:'“˜',31163:'—£',31171:'“Ã',31174:'âb',31181:'í',31215:'Ï',31229:'âq',31237:'Å',31267:'‘h',31283:'‰¸',31308:'‘h',31313:'âp',31351:'‹‡',31373:'â',31377:'—q',31388:'â‚',31389:'â|',31397:'‰M',31398:'â…',31405:'â€',31446:'’G',31454:'‹£',31491:'“Ä',31508:'•M',31509:'â¨',31546:'à®',31548:'˜U',31578:'âÈ',31579:'â¿',31609:'âÔ',31614:'âİ',31616:'ŠÈ',31654:'âÅ',31655:'â¸',31659:'âÒ',31697:'âÍ',31699:'âË',31713:'™Ó',31726:'âÕ',31729:'âß',31774:'’\',31809:'âÛ',31858:'™Ü',31860:'âù',31867:'—Ş',31900:'âú',31901:'âø',31914:'•³',31925:'âã',31930:'•B',32039:'‹Ù',32085:'â',32160:'—Î',32227:'‰',32325:'ŒJ',32328:'ãy',32353:'ãT',32363:'Œq',32394:'ãE',32416:'âû',32417:'âü',32418:'g',32419:'ã@',32420:'ãš',32422:'–ñ',32423:'‹‰',32425:'ãL',32426:'‹I',32428:'ˆÜ',32429:'ãA',32431:'ƒ',32432:'ãB',32433:'Ñ',32434:'j',32435:'”[',32437:'c',32438:'ãd',32439:'•´',32440:'›á',32441:'–ä',32442:'–a',32445:'•R',32447:'ü',32448:'®',32449:'ãQ',32451:'—û',32452:'‘g',32453:'a',32454:'×',32455:'D',32456:'I',32458:'ãJ',32461:'Ğ',32462:'ãˆ',32463:'Œo',32464:'ãH',32466:'ãO',32467:'Œ‹',32468:'ŒÑ',32469:'ç«',32471:'ãM',32472:'ŠG',32473:'‹‹',32474:'ˆº',32475:'ãK',32476:'—',32477:'â',32478:'i',32479:'“',32482:'Œ¦',32483:'ãT',32485:'ãV',32486:'ãU',32487:'Œp',32489:'™¨',32490:'',32491:'ˆ»',32493:'‘±',32494:'ãY',32495:'”ê',32496:'ã^',32499:'“ê',32500:'ˆÛ',32501:'ãc',32502:'ø',32503:'ã}',32504:'’Û',32507:'ã[',32508:'‘',32509:'’]',32510:'ãf',32511:'—Î',32512:'’Ô',32513:'ã]',32516:'ãg',32517:'–É',32518:'ãœ',32520:'ãl',32521:'ãh',32526:'ãj',32530:'ãv',32531:'ŠÉ',32532:'’÷',32533:'ã~',32534:'•Ò',32535:'ãm',32536:'‰',32537:'ãu',32538:'”›',32539:'ãt',32541:'–D',32543:'È',32544:'“Z',32546:'ão',32548:'ã',32549:'ã|',32550:'ã{',32551:'ã€',32552:'ã—',32553:'k',32554:'ãx',32555:'ŒJ',32556:'ã’',32557:'ã‡',32558:'‘U',32562:'ŒJ',32565:'ã“',32573:'”«',32578:'ã ',32584:'ã¢',32599:'—…',32602:'ã­',32610:'”ë',32628:'ã¯',32641:'ã²',32673:'‘A',32728:'ãÉ',32824:'ãŞ',32834:'ãá',32843:'˜W',32844:'E',32845:'ãâ',32852:'ãİ',32874:'‘',32899:'l',32928:'’°',32932:'•†',32958:'t',32959:'î',32960:'’¯',32961:'˜e',32988:'Ÿ',32999:'O',33002:'äe',33003:'ãø',33005:'äb',33014:'äP',33037:'éä',33039:'‘Ÿ',33040:'ä`',33041:'”]',33043:'”^',33044:'äg',33067:'’E',33080:'ä_',33098:'äd',33133:'ê›',33139:'‹r',33147:'äV',33149:'äK',33150:'“«',33211:'ã½',33286:'—`',33315:'ä~',33320:'”Â',33328:'ŠÍ',33329:'äy',33339:'äƒ',33392:'ä…',33395:'‰',33401:'ä‡',33402:'åY',33410:'ß',33436:'•“',33479:'ˆ¯',33484:'äÇ',33485:'‘“',33486:'’—',33487:'áS',33551:'åc',33553:'’Ó',33556:'šÈ',33557:'à‰',33575:'–š',33606:'Œt',33620:'ä«',33626:'ä°',33627:'äû',33630:'‹¼',33631:'åF',33632:'åT',33633:'áº',33635:'‰h',33636:'äÖ',33638:'à¶',33640:'å@',33643:'ˆü',33647:'äŞ',33714:'˜@',33715:'ª',33716:'äà',33719:'Šn',33720:'åC',33721:'àğ',33722:'ê^',33724:'äñ',33743:'ŸÏ',33802:'—‰',33821:'åf',33828:'Œu',33829:'‰c',33831:'åJ',33832:'F',33950:'ä¬',34013:'—•',34015:'åH',34019:'åP',34022:'é}',34083:'Ó',34085:'”K',34103:'åK',34106:'åa',34108:'å\',34164:'åD',34224:'ŒO',34259:'åd',34383:'—¸',34385:'—¶',34395:'‹•',34429:'å«',34430:'‰Ú',34432:'I',34433:'‹a',34476:'å„',34506:'åÁ',34511:'å¸',34544:'å­',34546:'å²',34581:'åˆ',34583:'å—',34593:'˜X',34631:'”ˆ',34684:'å±',34686:'å¼',34796:'ä',34847:'˜X',34885:'çÕ',34900:'çğ',34917:'•â',34924:'æD',34926:'åÏ',34948:'‰¦',34949:'›]',34972:'èç',34989:'P',35014:'åû',35018:'›]',35044:'ŒÑ',35099:'åø',35122:'ŒÑ',35124:'æA',35195:'æF',35265:'Œ©',35266:'ŠÏ',35268:'‹K',35269:'æK',35270:'‹',35271:'æL',35272:'——',35273:'Šo',35274:'æP',35275:'æM',35276:'æU',35278:'æO',35279:'æQ',35280:'æR',35284:'‹Ø',35294:'æ[',35466:'“£',35498:'à',35745:'Œv',35746:'’ù',35747:'æ]',35748:'”F',35749:'æ˜',35750:'æ_',35751:'æ`',35752:'“¢',35753:'÷',35755:'æ^',35757:'ŒP',35758:'‹c',35759:'u',35760:'‹L',35762:'u',35763:'æ',35764:'æ',35766:'æb',35767:'æc',35768:'‹–',35769:'æ—',35770:'˜_',35772:'×',35773:'æ…',35774:'İ',35775:'–K',35776:'Œ',35777:'Ø',35778:'æe',35779:'æd',35780:'•]',35781:'æf',35782:'¯',35784:'¼',35785:'œÅ',35786:'f',35787:'æh',35789:'Œ',35791:'Ù',35793:'–ó',35794:'æg',35796:'æp',35797:'',35799:'',35800:'‹l',35801:'æj',35802:'½',35803:'æn',35805:'˜b',35806:'’a',35807:'æl',35808:'‘F',35809:'æk',35810:'æm',35811:'Œw',35812:'æy',35813:'ŠY',35814:'Ú',35815:'˜l',35816:'æ„',35819:'ær',35820:'æw',35821:'Œê',35822:'æv',35823:'Œë',35824:'æt',35825:'—U',35826:'æq',35827:'æs',35828:'à',35829:'æu',35830:'ŸV',35831:'¿',35832:'”',35833:'z',35834:'‘ø',35835:'“Ç',35837:'”î',35838:'‰Û',35840:'æ‡',35841:'’N',35843:'’²',35844:'æz',35845:'—È',35846:'æx',35848:'’k',35850:'‹b',35851:'–d',35853:'’³',35855:'ŠĞ',35856:'æ~',35857:'æ‚',35858:'‰y',35859:'ˆà',35860:'æ€',35861:'—@',35863:'æ§',35864:'',35865:'æ}',35866:'Œ¿',35867:'’ú',35868:'“ä',35869:'æ†',35871:'æ•',35873:'æŒ',35874:'Ó',35875:'—w',35876:'æ',35877:'æŠ',35878:'Œª',35879:'æ',35880:'‹Ş',35881:'æ”',35882:'æ“',35884:'•T',35885:'æ',35886:'æœ',35889:'•ˆ',35890:'æ™',35892:'æ¢',35893:'æ',35894:'æ©',35924:'‰',35987:'”L',36084:'—Š',36119:'Šä',36125:'ŠL',36126:'’å',36127:'•‰',36129:'v',36130:'à',36131:'Ó',36132:'Œ«',36133:'”s',36135:'‰İ',36136:'æÂ',36137:'”Ì',36138:'æÃ',36139:'•n',36140:'æÈ',36141:'w',36142:'’™',36143:'ŠÑ',36144:'˜¯',36145:'‘G',36146:'æÊ',36147:'–á',36148:'“\',36149:'‹M',36151:'‘İ',36152:'–f',36153:'”ï',36154:'‰ê',36155:'æÄ',36156:'‘¯',36157:'æÑ',36158:'æÉ',36159:'˜d',36160:'æÅ',36161:'’À',36162:'˜G',36163:'æÚ',36164:'‘',36166:'æ×',36168:'“ö',36169:'æÍ',36171:'•Š',36172:'“q',36173:'æØ',36174:'æÜ',36175:'Ü',36176:'’',36180:'”…',36182:'—Š',36184:'æÒ',36185:'æĞ',36186:'æÏ',36187:'æÎ',36189:'Šä',36190:'æ«',36192:'‘¡',36193:'æÖ',36194:'æÕ',36213:'æâ',36235:'–',36284:'–š',36291:'–ô',36292:'çB',36344:'çJ',36347:'çR',36364:'çS',36396:'çT',36399:'çU',36433:'çY',36434:'çI',36495:'çX',36530:'ç]',36544:'‹ë',36710:'Ô',36711:'ça',36712:'‹O',36713:'Œ¬',36716:'“]',36717:'çb',36718:'—Ö',36719:'“î',36720:'çc',36722:'çe',36723:'ç‚',36724:'²',36726:'çd',36728:'çf',36729:'ç€',36731:'Œy',36732:'çg',36733:'Ú',36734:'çh',36735:'ç|',36738:'çi',36739:'Šr',36740:'çl',36741:'•ã',36742:'çq',36743:'çr',36744:'”y',36745:'‹P',36749:'ço',36750:'çn',36751:'çs',36752:'çt',36753:'S',36755:'—A',36756:'ŒD',36757:'çv',36758:'Š',36759:'çx',36760:'ç{',36761:'“Q',36774:'™Ÿ',36777:'ç‡',36779:'ã',36793:'ç³',36797:'—É',36798:'’B',36801:'‘J',36807:'‰ß',36808:'ç°',36816:'‰^',36824:'ŠÒ',36825:'”‡',36827:'i',36828:'‰“',36829:'ˆá',36830:'˜A',36831:'’x',36851:'ç”',36866:'“K',36873:'‘I',36874:'‘»',36882:'’ü',36923:'ç´',36951:'ˆâ',37038:'—X',37049:'ç¾',37051:'çÁ',37073:'“A',37112:'çÀ',37129:'‹½',37233:'İ',37247:'ø',37292:'İ',37297:'”®',37322:'ß',37492:'èg',37550:'èu',37555:'‰s',37636:'˜^',37686:'•\',37694:'èS',37706:'˜B',37885:'çö',37934:'Š™',37988:'çî',38024:'èI',38025:'“B',38031:'‹ú',38035:'’Ş',38039:'çŞ',38044:'çè',38045:'“İ',38046:'çâ',38047:'à',38050:'|',38051:'çå',38053:'èo',38054:'‹Ô',38055:'çà',38057:'çê',38062:'çä',38065:'‘K',38066:'Ş',38067:'çç',38068:'çó',38069:'”«',38074:'œø',38075:'ès',38079:'çí',38081:'çì',38083:'—é',38084:'èj',38085:'‰”',38086:'çô',38089:'çé',38090:'çë',38094:'‘ö',38103:'çõ',38104:'×',38105:'è^',38107:'èe',38108:'“º',38112:'ŠZ',38114:'çñ',38115:'‘L',38120:'çò',38123:'’¶',38125:'–Á',38126:'èB',38131:'e',38134:'‹â',38136:'’’',38138:'äs',38142:'èY',38143:'èR',38144:'ç÷',38145:'½',38148:'ãÒ',38149:'“ç',38152:'çö',38155:'–N',38160:'‰s',38166:'K',38169:'ö',38170:'•d',38177:'à',38178:'çü',38179:'èt',38180:'’È',38181:'',38182:'‹Ñ',38189:'ù',38190:'Œ®',38191:'‹˜',38193:'è@',38197:'èU',38199:'’Õ',38201:'ŒL',38202:'ß',38203:'’b',38208:'“t',38210:'èZ',38214:'”œ',38215:'’Á',38218:'èq',38220:'èb',38224:'èM',38226:'èL',38228:'•e',38232:'èW',38236:'‹¾',38237:'“L',38238:'èV',38241:'è\',38243:'è`',38246:'è]',38251:'“¨',38252:'èv',38256:'Š™',38271:'’·',38290:'ŠÔ',38321:'‰{',38342:'”Â',38376:'–å',38377:'èx',38378:'‘M',38381:'•Â',38382:'–â',38383:'è',38384:'‰[',38386:'ŠÕ',38388:'ŠÔ',38389:'è{',38391:'–ã',38392:'è}',38393:'è~',38394:'è',38395:'•·',38396:'è’',38398:'èƒ',38400:'”´',38401:'}',38404:'é«',38405:'‰{',38408:'è‡',38409:'è†',38411:'é©',38414:'è…',38415:'è„',38416:'è‘',38417:'èŒ',38418:'èŠ',38420:'è‰',38422:'è',38425:'è',38431:'‘à',38449:'âv',38451:'—z',38452:'‰A',38453:'w',38454:'ŠK',38469:'Û',38470:'—¤',38471:'è­',38472:'’Â',38485:'è',38504:'è¦',38505:'›Ó',38544:'‰B',38589:'è²',38590:'“ï',38607:'—',38622:'Œ{',38624:'æ¦',38643:'èÌ',38654:'–¶',38657:'èÇ',38665:'ê€',38701:'èÉ',38757:'èÒ',38801:'èå',38860:'x',38886:'èè',38887:'x',38889:'ŠØ',38892:'èé',38960:'–j',38969:'èö',39029:'•Å',39030:'’¸',39031:' ',39033:'€',39034:'‡',39035:'é¢',39037:'Šæ',39038:'ŒÚ',39039:'“Ú',39041:'”Ğ',39042:'èñ',39043:'èğ',39044:'—a',39045:'é@',39046:'—Ì',39047:'œ',39048:'Œz',39049:'èô',39050:'–j',39053:'Ÿñ',39056:'èó',39057:'•p',39059:'èö',39060:'èõ',39062:'‰o',39063:'è÷',39064:'‘è',39066:'Š{',39068:'èø',39069:'Šz',39070:'éB',39072:'“^',39076:'èú',39078:'èü',39079:'éA',39118:'•—',39122:'éD',39123:'éF',39128:'éH',39129:'éI',39134:'”ò',39144:'‹À',39269:'‹Q',39272:'éJ',39275:'éK',39276:'™ª',39277:'”Ñ',39278:'ˆù',39279:'éS',39280:'ü',39281:'–O',39282:'”',39284:'ˆ¹',39285:'‰a',39286:'é`',39287:'éM',39290:'éL',39292:'éU',39295:'‰ì',39296:'éP',39297:'éN',39301:'éQ',39302:'ŠÚ',39304:'éX',39311:'éY',39313:'é[',39314:'é\',39316:'éa',39345:'‘Ê',39506:'‘Ë',39532:'”n',39533:'éf',39534:'‘Ê',39535:'“é',39536:'’y',39537:'‹í',39539:'éo',39540:'é†',39542:'éj',39543:'éi',39545:'‹î',39547:'’“',39548:'ék',39549:'ém',39550:'‰í',39551:'‰w',39552:'él',39553:'é‚',39554:'”l',39556:'é',39558:'ép',39559:'én',39560:'éw',39562:'é‹',39563:'ét',39564:'Œ±',39567:'x',39568:'éu',39569:'‹R',39571:'év',39574:'é|',39575:'éx',39578:'‘›',39582:'éy',39584:'é~',39585:'é€',39588:'é…',39589:'é‡',39591:'éˆ',39621:'é',39693:'ŒÓ',39699:'é¤',39751:'é´',39753:'é²',40009:'êˆ',40055:'˜k',40060:'‹›',40065:'˜D',40066:'éµ',40070:'é·',40071:'ˆ¼',40072:'éç',40075:'•©',40077:'é¸',40081:'ø',40084:'–',40091:'L',40092:'›–',40099:'Š',40100:'Œï',40103:'é¿',40104:'éÀ',40109:'I',40113:'éÊ',40114:'éÈ',40117:'éÇ',40118:'éÎ',40119:'‘â',40120:'Œ~',40123:'éÉ',40125:'éÕ',40131:'éÒ',40132:'˜k',40133:'éÓ',40134:'éÖ',40135:'éÑ',40140:'ê‡',40141:'•h',40143:'éÛ',40148:'éâ',40149:'’L',40150:'êˆ',40151:'‰V',40158:'—Ø',40159:'–',40162:'éå',40407:'‰¨',40479:'’¹',40480:'”µ',40481:'Œ{',40482:'“Î',40483:'–Â',40485:'‰¨',40486:'éë',40488:'“¼',40489:'çÃ',40490:'éó',40491:'êH',40493:'Š›',40495:'éñ',40497:'éô',40499:'‰•',40501:'éö',40503:'êX',40509:'éù',40510:'êa',40511:'ƒ',40515:'êC',40516:'”',40517:'êA',40520:'‰L',40521:'–·',40522:'êF',40526:'êJ',40527:'–Q',40529:'êG',40535:'êL',40536:'êR',40540:'êN',40542:'êW',40548:'’ß',40550:'ê_',40551:'êY',40553:'ê]',40554:'ê[',40555:'˜h',40556:'êZ',40557:'ë',40560:'‘é',40563:'ê`',40572:'Œ²',40583:'êj',40612:'êe',40628:'',40629:'êp',40637:'›õ',40643:'‰©',40649:'ês',40657:'•',40679:'êt',40681:'ê‚',40702:'ê†',40784:'Ä',40785:'èë',40831:'•',40832:'ê',40835:'ê’',40836:'—î',40838:'ê“',40840:'ê•',40841:'ê—',40842:'ê˜',40843:'êš',40844:'ê™',40857:'—³',40859:'êœ',40863:'‹T',64012:'™Y',

// from http://dokochina.com/sim2tra.htm
25168:'˜¼',24194:'˜º',20417:'–“',20655:'˜ö',20936:'ò',21032:'çî',21032:'çî',24390:'•Ê',39091:'™‰',21243:'ú‰',21179:'‹§',21385:'ú',34937:'‘ü',37059:'‡',22169:'ê–',31984:'’c',38532:'’ç',20245:'•v',23329:'ˆ¤',25398:'‹Ç',23959:'™§',23896:'ú´',20330:'œj',21369:'œ•',22081:'ˆ«',24698:'úÄ',24701:'úÂ',24956:'Ê',20679:'C',23645:'”à',39098:'—g',25210:'’ï',25306:'V',35180:'²',25631:'I',25222:'C',37831:'ù',26050:'Šø',26289:'á',40623:'‹È',25268:'‰g',30787:'é',26521:'‰',26722:'úé',27422:'ŸQ',34215:'Ç',33379:'ä„',27305:'œì',35362:'‹Ó',25230:'Ÿm',20235:'‹‚',27902:'úû',28386:'ûN',24017:'àA',28757:'àA',32303:'‰‰',28904:'ûY',28952:'ûZ',29339:'à³',29367:'û_',29711:'ûl',30266:'á‘',30570:'áÎ',30806:'ûz',22591:'Œ²',32785:'’[',32397:'—İ',32308:'ãš',32282:'ãU',32307:'”›',32559:'û',32408:'ã“',20792:'—…',22217:'—…',39194:'æ',30675:'O',39634:'‘Ÿ',33148:'èÑ',34937:'’v',22220:'áS',33549:'ä‘',25054:'–Ö',34890:'•Ì',36385:'å',23325:'›]',35474:'ŸV',35852:'ûª',36124:'æÚ',36245:'û°',23719:'ç‹',37011:'û¹',30176:'_',38026:'û»',38032:'û¿',38052:'ûÂ',38064:'ûÄ',37446:'ès',38078:'ûÅ',38082:'ûÉ',38093:'ûÊ',37897:'‘L',38128:'ûÎ',38206:'ûß',37836:'”œ',37964:'•e',38235:'ûã',37962:'èv',39074:'ûõ',39309:'âõ',40369:'éy',

0x20BB7: '‹g'
};


// “à•”‚Åg—p: WideCharToMultiByte ‚Å U+3099AU+309A ‚ğŒ‹‡o—ˆ‚é•¶š‚Ìí—Şƒe[ƒuƒ‹
//  0 ... ‚©`‚ÍƒJ`ƒns(‘÷“_‚Ì‚İ)
//  1 ... ‚Íƒns(‘÷“_‚¨‚æ‚Ñ”¼‘÷“_)
Utf8.prototype._kanaTable = {
0x304B: 0,
0x304D: 0,
0x304F: 0,
0x3051: 0,
0x3053: 0,
0x3055: 0,
0x3057: 0,
0x3059: 0,
0x305B: 0,
0x305D: 0,
0x305F: 0,
0x3061: 0,
0x3064: 0,
0x3066: 0,
0x3068: 0,
0x306F: 1,
0x3072: 1,
0x3075: 1,
0x3078: 1,
0x307B: 1,
0x30AB: 0,
0x30AD: 0,
0x30AF: 0,
0x30B1: 0,
0x30B3: 0,
0x30B5: 0,
0x30B7: 0,
0x30B9: 0,
0x30BB: 0,
0x30BD: 0,
0x30BF: 0,
0x30C1: 0,
0x30C4: 0,
0x30C6: 0,
0x30C8: 0,
0x30CF: 1,
0x30D2: 1,
0x30D5: 1,
0x30D8: 1,
0x30DB: 1
};


// ƒIƒuƒWƒFƒNƒg‚ğ•¡»‚·‚é ¨ –ß‚è’l: Utf8
Utf8.prototype.clone = function () {
  return new Utf8 (this.text);
};


// UTF-8 •¶š—ñ‚É•ÏŠ·‚·‚é ¨ –ß‚è’l: string
Utf8.prototype.toUTF8 = function () {
  return this.text;
};


// Unicode ƒR[ƒhƒ|ƒCƒ“ƒg‚ğ UTF-8 •¶š—ñ‚É•ÏŠ·‚·‚é ¨ –ß‚è’l: string
Utf8.prototype.fromUnicode = function (u) {
  if (u <= 0x7f) {
    return String.fromCharCode (u);
  }
  if (u <= 0x7ff) {
    var n1 = u >> 6;
    var n2 = u & 0x3f;
    return String.fromCharCode (n1 + 0xc0, n2 + 0x80);
  }
  if (u <= 0xffff) {
    var n1 = u >> 12;
    var n2 = (u >> 6) & 0x3f;
    var n3 = u & 0x3f;
    return String.fromCharCode (n1 + 0xe0, n2 + 0x80, n3 + 0x80);
  }
  if (u <= 0x1fffff) {
    var n1 = u >> 18;
    var n2 = (u >> 12) & 0x3f;
    var n3 = (u >> 6) & 0x3f;
    var n4 = u & 0x3f;
    return String.fromCharCode (n1 + 0xf0, n2 + 0x80, n3 + 0x80, n4 + 0x80);
  }

  return '[UTF-8 error]';
};


// ƒ^ƒO‚ğíœ‚·‚é ¨ –ß‚è’l: Utf8
Utf8.prototype.removeTags = function () {
  var sb = new StringBuffer (this.text);

  for (var lt = 0; ;) {
    lt = sb.indexOf ('<', lt);
    if (lt == -1) {
      break;
    }

    var gt = sb.indexOf ('>', lt);
    if (gt == -1) {
      break;
    }

    // < ‚©‚ç > ‚Ü‚Å‚ğíœ
    sb.delete (lt, gt + 1);
  }

  return new Utf8 (sb.text);
};


// •¶šQÆ‚ğƒfƒR[ƒh‚·‚é ¨ –ß‚è’l: Utf8
Utf8.prototype.decodeCharRef = function () {
  var q_tbl = { 'amp': '&', 'lt': '<', 'gt': '>', 'quot': '"', 'apos': "'",
    'nbsp': String.fromCharCode (0xc2, 0xa0)
  };

  var r = new StringBuffer ();

  var sb = new StringBuffer (this.text);
  sb.charAt = function (idx) {
    return String.fromCharCode (this.charCodeAt (idx));
  };

  while (sb.length > 0) {
    var a = sb.indexOf ('&');
    if (a == -1) {
      // & ‚ª‚È‚¢‚Ì‚ÅI‚í‚è
      r.append (sb);
      break;
    }

    if (a > 0) {
      // '&' ‚æ‚èè‘O‚ğˆ—Ï‚İƒoƒbƒtƒ@‚ÖˆÚ‚·
      r.append (sb.slice (0, a));
      sb.delete (0, a);
    }

    // sb.charAt (0) == '&'

    var j = 1;  // Ÿ‚Ì•¶š‚ÌƒCƒ“ƒfƒbƒNƒX
    var c = sb.charAt (j++);

    if (c == '#') {
      // &# c ”’l•¶šQÆ
      var num = '';
      var num_re = /^\d$/;
      c = sb.charAt (j++);

      if (c == 'x' || c == 'X') {
        // &#x c 16i•\‹L
        num = '$';
        num_re = /^[\da-f]$/i;
        c = sb.charAt (j++);
      }

      // ”š‚ğæ‚èo‚µ‚ÄƒR[ƒhƒ|ƒCƒ“ƒg‚É•ÏŠ·
      while (num_re.test (c)) {
        num += c;
        c = sb.charAt (j++);
      }
      if (c != ';') {
        --j;
      }
      num = parseInt (num);  // num == '' / '$' ‚Ìê‡‚Í NaN ‚É‚È‚é
      if (! ((0 < num) && (num <= 0x0010ffff))) {
        // •s³‚ÈƒR[ƒhƒ|ƒCƒ“ƒg‚¾‚Á‚½
        r.append (sb.slice (0, j));
        sb.delete (0, j);
        continue;
      }

      // ƒR[ƒhƒ|ƒCƒ“ƒg‚ğ UTF-8 ‚É•ÏŠ·
      r.append (this.fromUnicode (num));
      sb.delete (0, j);
      continue;
    }

    // ”’l•¶šQÆ‚Å‚È‚¯‚ê‚Î•¶šÀ‘ÌQÆ
    var ref = '';

    // –¼Ì‚ğæ‚èo‚·
    while (/[a-z0-9]/i.test (c)) {
      ref += c;
      c = sb.charAt (j++);
    }
    if (c != ';') {
      --j;
    }

    if (ref != '') {
      if (q_tbl.hasKey (ref)) {
        // Œy—Êƒe[ƒuƒ‹‚©‚çŒ©‚Â‚©‚Á‚½‚ç‚»‚Ì‚Ü‚Üo—Í
        r.append (q_tbl [ref]);
        sb.delete (0, j);
        continue;
      }

      // ‰‰ñÀs‚É Utf8_charref.dms ‚ğ“Ç‚İ‚Ş
      if (this._charRefTable == null) {
        this._loadCharRefTable ();
      }

      if (this._charRefTable.hasKey (ref)) {
        // ³®ƒe[ƒuƒ‹‚©‚çŒ©‚Â‚©‚Á‚½‚ç•ÏŠ·‚µ‚Äo—Í

        var cp = this._charRefTable [ref];
        if (typeof cp == 'number') {
          r.append (this.fromUnicode (cp));
        }
        else {
          for (var k = 0; k < cp.length; ++k) {
            r.append (this.fromUnicode (cp [k]));
          }
        }

        sb.delete (0, j);
        continue;
      }
    }

    // –¢’è‹`‚Ì–¼ÌA‚Ü‚½‚Í & ‚¾‚¯‚ÅI‚í‚Á‚½ê‡‚â &; ‚Ì‚İ‚Ìê‡
    r.append (sb.slice (0, j));
    sb.delete (0, j);
    continue;
  }

  return new Utf8 (r.text);
};


// Shift_JIS •¶š—ñ‚É•ÏŠ·‚·‚é ¨ –ß‚è’l: string
//  1. Win32 API ‚ÅD‚Ü‚µ‚¢•ÏŠ·Œ‹‰Ê‚É‚È‚ç‚È‚¢•¶š‚ğ’T‚·B
//  2. ‚»‚Ì’¼‘O‚Ì•¶š—ñ‚ğ Win32 API ‚Å•ÏŠ·‚·‚éB
//  3. 1‚ÅŒ©‚Â‚¯‚½•¶š‚ğ©‘O‚Å•ÏŠ·‚·‚éB
//  4. ŒJ‚è•Ô‚µ
Utf8.prototype.toSJIS = function () {
  // ASCII ‚Ì‚İ‚È‚ç‚»‚Ì‚Ü‚Ü•Ô‚·B‚½‚¾‚µ \ ‚Í•ÏŠ·ˆ—‚ğs‚¤
  if (/^[\s -\[\]-~]*$/.test (this.text)) {
    return this.text;
  }

  var sb = new StringBuffer (this.text);
  var sb_len = sb.length;

  var result = '';

  // Win32 API ‚Å•ÏŠ·‚µ‚Ä‚¢‚È‚¢æ“ªˆÊ’u
  var start = 0;

  var len, unicode, n1, n2, n3, n4;

  for (var i = 0; i < sb_len; i += len) {
    n1 = sb.charCodeAt (i);

    // UTF-8 ‚ÌƒoƒCƒg”‚ğ”»•Ê‚µ‚Ä•¶šƒR[ƒh‚ğæ‚èo‚·
    if (n1 <= 0x7f) {
      len = 1;
      unicode = n1;
    }
    else if (n1 <= 0xc1) {  // 0x80-0xc1 •s³‚ÈƒR[ƒh
      len = 1;
      continue;
    }
    else if (n1 <= 0xdf) {
      len = 2;
      n1 = n1 & 0x1f;
      n2 = sb.charCodeAt (i + 1) & 0x3f;
      unicode = (n1 << 6) + n2;
    }
    else if (n1 <= 0xef) {
      len = 3;
      n1 = n1 & 0x0f;
      n2 = sb.charCodeAt (i + 1) & 0x3f;
      n3 = sb.charCodeAt (i + 2) & 0x3f;
      unicode = (n1 << 12) + (n2 << 6) + n3;
    }
    else if (n1 <= 0xf7) {
      len = 4;
      n1 = n1 & 0x07;
      n2 = sb.charCodeAt (i + 1) & 0x3f;
      n3 = sb.charCodeAt (i + 2) & 0x3f;
      n4 = sb.charCodeAt (i + 3) & 0x3f;
      unicode = (n1 << 18) + (n2 << 12) + (n3 << 6) + n4;
    }
    else {  // 0xf8-0xff •s³‚ÈƒR[ƒh
      len = 1;
      continue;
    }

    // ƒR[ƒhƒ|ƒCƒ“ƒg‚²‚Æ‚É•K—v‚Èˆ—‚ğs‚¤

    if (this._kanaTable.hasKey (unicode)) {
      // ‚©‚È+Œ‹‡•¶š‚Ìƒ`ƒFƒbƒN
      // U+3099 (UTF-8:E3 82 99) ‘÷“_
      // U+309A (UTF-8:E3 82 9A) ”¼‘÷“_

      n1 = i + len;
      if ((n1 + 3) <= sb_len &&
          sb.charCodeAt (n1) == 0xe3 && sb.charCodeAt (n1 + 1) == 0x82) {
        n3 = sb.charCodeAt (n1 + 2);
        if (n3 == 0x99 || (n3 == 0x9a && this._kanaTable [unicode])) {
          // ‚±‚Ì•¶š‚É‰Á‚¦‚ÄŸ‚ÌŒ‹‡•¶š‚à Win32 API ‚Å•ÏŠ·‰Â”\
          len += 3;
        }
      }
    }
    else if (this._u2sTable.hasKey (unicode)) {
      // •ÏŠ·ƒe[ƒuƒ‹‚ÉŠY“–‚ ‚è

      // –¢•ÏŠ·•”•ª‚ğ•ÏŠ·
      if (start < i) {
        result += this._toSJIS (sb.slice (start, i));
      }
      start = i + len;

      result += this._u2sTable [unicode];
    }
    else if (0x10000 <= unicode) {
      // U+10000 ˆÈã‚Ì(UTF-16 ‚É‚¨‚¢‚ÄƒTƒƒQ[ƒgƒyƒA‚Æ‚È‚é)•¶š‚Í
      // WideCharToMultiByte() ‚Å ?? ‚É‚È‚Á‚Ä‚µ‚Ü‚¤‚Ì‚ÅAŒˆ‚ß‘Å‚¿‚Å
      // '?' ‚É•ÏŠ·‚·‚é

      // –¢•ÏŠ·•”•ª‚ğ•ÏŠ·
      if (start < i) {
        result += this._toSJIS (sb.slice (start, i));
      }
      start = i + len;

      result += '?';
    }
  }

  // c‚è‚Ì–¢•ÏŠ·•”•ª‚ğ•ÏŠ·
  if (start < i) {
    result += this._toSJIS (sb.slice (start, i));
  }

  return result;
};


Utf8.prototype._unescapeMap = {
  'b': "\b", 'f': "\f", 't': "\t", "'": "'", '"': '"', '\': '\',
  'r': "\r", 'n': String.fromCharCode (10), 'v': String.fromCharCode (11)
};

// JavaScript ‚Ì•¶š—ñƒŠƒeƒ‰ƒ‹Œ`®‚ÉŠÜ‚Ü‚ê‚é \ ƒGƒXƒP[ƒvƒV[ƒPƒ“ƒX‚ğ•œ†‚·‚é
Utf8.prototype.unescape = function () {
  var sb = new StringBuffer (this.text);
  var r = new StringBuffer ();

  var sbLen = sb.length;
  var prev = -1;
  for (var i = 0; i < sbLen; ) {
    if (i == prev) {
      alert ('Utf8.unescape(): “à•”ƒGƒ‰[ (i == prev)');
      exit ();
    }
    prev = i;

    var a = sb.indexOf ('\', i);  // sbLen <= i ‚Ì .indexOf() ‚ğg‚í‚È‚¢‚±‚Æ
    if (a == -1) {
      // \ ‚ª‚È‚¢‚Ì‚Åc‚è‚ğˆ—Ï‚İƒoƒbƒtƒ@‚ÖƒRƒs[‚µ‚ÄI‚í‚è
      r.append (sb.substring (i));
      break;
    }

    if (i < a) {
      // \ ‚æ‚èè‘O‚ğˆ—Ï‚İƒoƒbƒtƒ@‚ÖƒRƒs[
      r.append (sb.substring (i, a));
      i = a;
    }

    var s, c = sb.substr (i + 1, 1);
    i += 2;

    if (c == 'x') {
      // \xXX ... \x00`\xff
      s = sb.substr (i, 2);
      if (/^[0-9a-f]{2}/i.test (s)) {
        i += 2;
        c = String.fromCharCode (parseInt ('0x' + s));
      }
    }
    else if (c == 'u') {
      // \uXXXX ... \u0000`\uffff
      s = sb.substr (i, 4);
      if (/^[0-9a-f]{4}/i.test (s)) {
        i += 4;
        s = parseInt ('0x' + s);  // 0`0xffff

        var m = s & 0xfc00;
        if (m == 0xd800) {
          // high surrogate
          var s2 = sb.substr (i, 6);  //  0`0xffff
          s2 = /^\\u[0-9a-fA-F]{4}/.test (s2) ? parseInt ('0x' + s2.slice (2)) : 0;

          if ((s2 & 0xfc00) == 0xdc00) {
            i += 6;
            c = this.fromUnicode (0x10000 + ((s & 0x03ff) << 10) + (s2 & 0x03ff));
          }
          else {
            // high surrogate ‚Ì’¼Œã‚ª low surrogate ‚Å‚Í‚È‚¢
            // ‚Ü‚½‚Í Unicode ƒGƒXƒP[ƒvƒV[ƒPƒ“ƒX‚Å‚Í‚È‚¢
            c = '[U+' + s + ']';
          }
        }
        else if (m == 0xdc00) {
          // ‚¢‚«‚È‚è low surrogate ‚ª‚«‚½
          c = '[U+' + s + ']';
        }
        else {
          // Šî–{‘½Œ¾Œê–Ê‚ÌƒR[ƒhƒ|ƒCƒ“ƒg
          c = this.fromUnicode (s);
        }
      }
    }
    else if (/^[0-3]/.test (c)) {
      // \XXX ... \000`\377
      s = sb.substr (i, 2);
      if (/^[0-7]{2}/.test (s)) {
        i += 2;
        c = this.fromUnicode (c.charCodeAt (0) * 64 +
              s.charCodeAt (0) * 8 + s.charCodeAt (1) - 0xdb0);
      }
    }
    else if (this._unescapeMap.hasKey (c)) {
      // \b \f \t \' \" \\ \r \n \v
      c = this._unescapeMap [c];
    }
    // ³‚µ‚­‚È‚¢ƒV[ƒPƒ“ƒX‚Í‚»‚Ì•¶š‚ğo—Í

    r.append (c);
  }

  return new Utf8 (r.text);
};


}) ()


// EOF
