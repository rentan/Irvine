download_by_irvine.htm  by rentan


Internet Explorer のコンテキストメニュー用のスクリプトです。


機能
====

リンクや画像を Irvine に登録します。

範囲選択の有無、Ctrl/Shift キーの押し下げ状態、右クリックした対象によって、
動作が切り替わります。

標準設定では以下のように動作します(上に書かれている方が優先)。

・リンクを範囲選択
  → 選択されているリンクを全てダウンロード

・テキストを範囲選択
  → テキスト内から URL を抽出して全てダウンロード

・Ctrl+Shift キーを押しながら
  → 全てのリンクを抽出してダイアログを表示

・Ctrl キーを押しながら
  → 現在のページ自体をダウンロード

・Shift キーを押しながら
  → 画像をダウンロード（画像リンクの場合も画像をダウンロード）
     img タグ以外なら背景画像をダウンロード

・リンク
  → リンク先をダウンロード

・画像
  → 画像をダウンロード
     イメージマップの場合は全てのリンクを抽出してダイアログを表示

・それ以外
  → 全てのリンクを抽出してダイアログを表示


キーの押し下げについて
======================

「～～ キーを押しながら」の動作を実行したい場合は、そのキーを押しながら
マウスの右ボタンをクリックしてコンテキストメニューを表示して下さい。

決定する瞬間のキー状態ではないので、単なる右クリックでメニュー表示後にキー
を押しながら「Irvineでダウンロード(&Z)」をクリックしても無視されます。

範囲選択なしの時に Shift+F10 キーでメニューを表示すると（その操作で Shift
キーを押しているため）、常に「Shift キーを押しながら」の動作が実行されます。

なお、IE の挙動として Shift キーを押しながら右クリックすると意図せずテキスト
が選択状態になってしまうことがあります。


インストール方法
================

1. download_by_irvine.htm を Irvine の ie_menu フォルダにコピーします。

2. ※標準ではコンテキストメニューのアクセラレータキーが Z になっています。
     他のキーに変更したい場合のみ、ここの手順を行なって下さい。

   コピーしたファイルをテキストエディタで開き、
     caption=Irvineでダウンロード(&Z)
   の Z を適宜書き換えます。

3. Irvine を再起動します（または、起動していなかった場合は起動します）。

4. ツール → オプション設定を開き、IEメニューのタブを開きます。

5. 「Irvineでダウンロード(&Z)」にチェックを入れて、OKボタンで閉じます。


アンインストール方法
====================

1. ツール → オプション設定を開き、IEメニューのタブを開きます。

2. 「Irvineでダウンロード(&Z)」のチェックを外して、OKボタンで閉じます。

3. Irvine の ie_menu フォルダにある download_by_irvine.htm を削除します。


設定変更
========

download_by_irvine.htm をテキストエディタで書き換えることで、
「Ctrl+Shift キーを押しながら」
「Ctrl キーを押しながら」
「Shift キーを押しながら」
「それ以外」
で実行する動作などの設定を変更することが出来ます。

詳しくはファイルを見て下さい。


仕様・制限事項
==============

・以下のプロトコルに対応しています。
  http://
  https://
  ftp://

・基本的にリファラを送信しますが、以下の場合は送信しません。
  テキストを範囲選択して URL を抽出した場合
  現在のページ自体をダウンロードする場合
  http:// 以外のページで実行した場合
  以下のページで実行した場合
    http://local.ptron/
    http://(www.)?inoreader.com/

・範囲選択したリンクが相対リンクだった場合に、やむを得ずページ内の DOM を
  一時的に書き換えます。

・画像ダウンロードで、複数の画像が重なっていると一番手前の画像を取得するため
  期待する画像をダウンロードできない場合があります。

・イメージマップは画像に含まれるリンクを全て抽出してダイアログを表示します。
  (<img name="～"><map name="～"><area href="～"></map>)


参考資料
========

http://support.microsoft.com/kb/177241
[InetSDK] ブラウザの標準コンテキスト メニューに項目を追加する

contexts =
  1:デフォルト 2:画像 4:コントロール 8:テーブル
  16:テキスト選択 32:リンク 64:その他

http://scripting.cocolog-nifty.com/blog/2007/11/post_4bb2.html
バッチファイルやスクリプトからシフトキー類の押し下げ状態を調べる。(その２)


変更履歴
========

2015-03-18  version 20150318
  前回の変更が動作していなかった不具合を修正。

2015-02-08  version 20150208
  選択範囲が display: none; の場合は無視するようにした。

2014-10-28  version 20141028
  ftp:// の URL エンコードを復号するようにした。
  ただし %20～%7e 以外の文字が含まれる場合は復号しない。

  ニコニコ動画の再生ページで「ページ内の全リンクをリスト追加」が
  動作しない不具合を修正。

2014-07-22  version 20140722
  ignore_img に clear.gif を追加。
  http://www.inoreader.com/ のリファラを送信しないようにした。

2014-03-27  version 20140327
  GNU GPL v3 or later を適用。
  国際化ドメイン名を punycode に変換する機能を追加。

  このファイルを UTF-8 に変更。

2013-11-14
  IE11 で document.selection が廃止された対策として、
  window.getSelection がある場合はそれを使うようにした。
      thanks to http://toro.2ch.net/test/read.cgi/win/1371715233/531

  以下の設定を廃止。
    no_obj_action  alert_if_no_link  alert_if_no_img

  設定の no_referer から http://www.google.co.jp/reader/ を削除、
  http://inoreader.com/ を追加。

  選択範囲にリンクがない場合はアクティブな要素をダウンロードするか
  問い合わせるようにした。

  event.srcElement が <html> を指していた場合は、<body> を対象に
  処理するようにした。

  # 例: http://luxury.nexton-net.jp/_product/lux001/_main.html
  # <body> 内に高さのあるボックスがないと <body> の高さが 0 になり、
  # <body> の背景画像をクリックしたつもりでも <html> をクリックした
  # ことになってしまう、という現象への対策。

2013-04-17
  Shift_JIS 以外のページで実行した時、URL に U+0080 以上の文字が含まれ
  ていれば %xx 形式にエンコードするようにした。

2013-01-26
  IE9 対応。
  イメージマップのリンクを抽出するようにした。
  ttp:// tp:// を http:// に補完するようにした。
  画像ダウンロードで blank.gif spacer.gif を無視するようにした
  (config.ignore_img で変更可能)。
  全てのリンクを抽出でリンクがなければダイアログを表示するようにした。

  URL のリストを専用オブジェクトで管理するようにした。

2012-03-05
  external.menuArguments.location.href を ～.document.URL に変更して、
  IE9 でも動作するようにした（手元に IE9 環境がないため動作未確認）。
    thanks to http://toro.2ch.net/test/read.cgi/win/1317200460/940

  リファラの送信可否判定を変更。
    旧: URL の先頭が file: または https: なら送信しない。
    新: URL の先頭が http:// の時のみ送信する。
  これにより、about:～ のページでリファラを送信しないようにした。

  リファラを送信しないサイトに http://local.ptron/ を追加。

  Ctrl+Shift、Ctrl キーの押し下げに対応。
  キー押し下げ時の動作を設定で変更できるようにした。

  現在のページ自体をダウンロードする動作を追加。
  リンクや画像以外を右クリックした時に（URL の抽出の代わりに）実行したい
  場合は以下のように書き換える。
    // クリック位置がリンクや画像でない時の動作
    no_obj_action: 'doc_url',
    http://toro.2ch.net/test/read.cgi/win/1330866405/6,10

  画像ダウンロードで、画像が見つからなかった場合にダイアログを表示する
  ようにした。

2012-02-21
  初期バージョン。


[EOF]
